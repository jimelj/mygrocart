name: Frontend Web CI/CD

on:
  push:
    branches: [main, develop]
    paths:
      - 'mygrocart-web/**'
      - '.github/workflows/frontend-web-ci-cd.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'mygrocart-web/**'

env:
  NODE_VERSION: '20.x'

jobs:
  ##############################################################################
  # CI: Continuous Integration (Runs on every push/PR)
  ##############################################################################

  typecheck-and-lint:
    name: TypeScript & Lint Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./mygrocart-web

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          cache-dependency-path: './mygrocart-web/pnpm-lock.yaml'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run TypeScript type check
        run: pnpm tsc --noEmit

      - name: Run ESLint
        run: pnpm lint

  build-test:
    name: Build Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./mygrocart-web

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          cache-dependency-path: './mygrocart-web/pnpm-lock.yaml'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Next.js app
        run: pnpm build
        env:
          # Use dummy values for build
          NEXT_PUBLIC_GRAPHQL_ENDPOINT: 'http://localhost:5001/graphql'

      - name: Check build output
        run: |
          if [ ! -d ".next" ]; then
            echo "❌ Build failed - .next directory not found"
            exit 1
          fi
          echo "✅ Build successful"

  accessibility-check:
    name: Accessibility Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./mygrocart-web

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          cache-dependency-path: './mygrocart-web/pnpm-lock.yaml'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Check for accessibility violations
        run: |
          # Check for common a11y issues in code
          echo "Checking for accessibility patterns..."

          # Check for alt text on images
          if grep -r "img src" --include="*.tsx" --include="*.jsx" . | grep -v "alt="; then
            echo "⚠️  Warning: Found images without alt text"
          fi

          # Check for skip navigation link
          if ! grep -r "skip-to-main" --include="*.tsx" --include="*.jsx" .; then
            echo "⚠️  Warning: No skip navigation link found"
          else
            echo "✅ Skip navigation link found"
          fi

          # Check for ARIA labels on buttons
          if grep -r "<button" --include="*.tsx" --include="*.jsx" . | grep -v "aria-label"; then
            echo "⚠️  Warning: Found buttons without aria-label"
          fi

          echo "✅ Basic accessibility checks complete"

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./mygrocart-web

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Run security audit
        run: pnpm audit --audit-level=moderate
        continue-on-error: true

  ##############################################################################
  # CD: Continuous Deployment (Only runs on main branch after CI passes)
  ##############################################################################

  deploy-to-vercel:
    name: Deploy to Vercel
    needs: [typecheck-and-lint, build-test]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          cache-dependency-path: './mygrocart-web/pnpm-lock.yaml'

      - name: Install Vercel CLI
        run: pnpm add -g vercel

      - name: Pull Vercel environment
        working-directory: ./mygrocart-web
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}

      - name: Build project
        working-directory: ./mygrocart-web
        run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}

      - name: Deploy to Vercel
        working-directory: ./mygrocart-web
        run: vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}

  post-deploy-notification:
    name: Post-Deploy Notification
    needs: [deploy-to-vercel]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Send deployment status
        run: |
          if [ "${{ needs.deploy-to-vercel.result }}" = "success" ]; then
            echo "✅ Frontend deployed successfully to Vercel"
            echo "URL: ${{ secrets.FRONTEND_URL }}"
          else
            echo "❌ Frontend deployment failed"
            exit 1
          fi
