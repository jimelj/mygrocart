name: Backend CI/CD

on:
  push:
    branches: [main, develop]
    paths:
      - 'mygrocart-backend-node/**'
      - '.github/workflows/backend-ci-cd.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'mygrocart-backend-node/**'

env:
  NODE_VERSION: '20.x'

jobs:
  ##############################################################################
  # CI: Continuous Integration (Runs on every push/PR)
  ##############################################################################

  lint-and-typecheck:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./mygrocart-backend-node

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          cache-dependency-path: './mygrocart-backend-node/pnpm-lock.yaml'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run ESLint
        run: pnpm lint || echo "No lint script found, skipping..."
        continue-on-error: true

      - name: Check for syntax errors
        run: node -c server.js

  build-check:
    name: Build Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./mygrocart-backend-node

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          cache-dependency-path: './mygrocart-backend-node/pnpm-lock.yaml'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Verify all imports resolve
        run: |
          node -e "
          const fs = require('fs');
          const path = require('path');

          // Check that all main files exist
          const files = [
            'server.js',
            'config/database.js',
            'config/redis.js',
            'resolvers/index.js',
            'schema/typeDefs.js',
            'services/CacheService.js',
            'services/ProductService.js',
            'services/ScrapingOrchestrator.js'
          ];

          let allExist = true;
          files.forEach(file => {
            if (!fs.existsSync(file)) {
              console.error('Missing file:', file);
              allExist = false;
            }
          });

          if (!allExist) process.exit(1);
          console.log('✅ All core files exist');
          "

      - name: Test GraphQL schema validity
        run: |
          node -e "
          const { buildSchema } = require('graphql');
          const fs = require('fs');
          const typeDefs = fs.readFileSync('./schema/typeDefs.js', 'utf8');
          // Extract schema from module.exports
          const schemaMatch = typeDefs.match(/gql\`([\s\S]*?)\`/);
          if (!schemaMatch) {
            console.error('Could not find GraphQL schema');
            process.exit(1);
          }
          try {
            buildSchema(schemaMatch[1]);
            console.log('✅ GraphQL schema is valid');
          } catch (err) {
            console.error('GraphQL schema error:', err.message);
            process.exit(1);
          }
          "

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./mygrocart-backend-node

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Run security audit
        run: pnpm audit --audit-level=moderate
        continue-on-error: true

  ##############################################################################
  # CD: Continuous Deployment (Only runs on main branch after CI passes)
  ##############################################################################

  deploy-to-render:
    name: Deploy to Render
    needs: [lint-and-typecheck, build-check]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest

    steps:
      - name: Trigger Render deployment
        run: |
          curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK_URL }}" \
            -H "Accept: application/json" \
            -H "Content-Type: application/json"

      - name: Wait for deployment
        run: sleep 60

      - name: Health check
        run: |
          # Try to hit the /graphql endpoint
          response=$(curl -s -o /dev/null -w "%{http_code}" "${{ secrets.BACKEND_URL }}/graphql" || echo "000")

          if [ "$response" = "400" ] || [ "$response" = "200" ]; then
            echo "✅ Backend is responding (HTTP $response)"
            exit 0
          else
            echo "❌ Backend health check failed (HTTP $response)"
            exit 1
          fi

  post-deploy-notification:
    name: Post-Deploy Notification
    needs: [deploy-to-render]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Send deployment status
        run: |
          if [ "${{ needs.deploy-to-render.result }}" = "success" ]; then
            echo "✅ Backend deployed successfully to Render"
            echo "URL: ${{ secrets.BACKEND_URL }}"
          else
            echo "❌ Backend deployment failed"
            exit 1
          fi
